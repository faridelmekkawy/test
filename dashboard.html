<!doctype html>
<html lang="en">
<head>
  <title>AFCON Nights ‚Äî Owner Dashboard</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1730;
      --panel2:#121d3a;
      --ink:#eef2ff;
      --muted:#a7b0d6;
      --border:rgba(255,255,255,.10);
      --accent:#7c3aed;
      --accent2:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --radius:18px;
      --shadow:0 22px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:
      radial-gradient(1200px 700px at 10% -10%, rgba(124,58,237,.35), transparent 60%),
      radial-gradient(900px 600px at 110% 10%, rgba(34,197,94,.25), transparent 55%),
      radial-gradient(900px 700px at 50% 120%, rgba(59,130,246,.18), transparent 55%),
      var(--bg);
      color:var(--ink);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    @media(max-width:640px){.wrap{padding:16px}}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center;min-width:240px}
    .dot{width:12px;height:12px;border-radius:999px;background:linear-gradient(135deg,var(--accent),#60a5fa)}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .grid{display:grid;gap:14px}
    .grid2{display:grid;grid-template-columns:1.4fr .9fr;gap:14px}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}}
    .pad{padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--ink);
      padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:800}
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#3b82f6);border-color:transparent}
    .btn.good{background:linear-gradient(135deg,#16a34a,#22c55e);border-color:transparent}
    .btn.danger{background:linear-gradient(135deg,#ef4444,#f97316);border-color:transparent}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .inp,.sel,textarea{background:rgba(0,0,0,.18);border:1px solid var(--border);color:var(--ink);
      padding:10px 12px;border-radius:14px;outline:none;min-width:220px}
    @media(max-width:520px){.inp,.sel{min-width:unset;width:100%}}
    textarea{min-width:unset;width:100%;min-height:92px;resize:vertical}
    label{font-size:12px;color:var(--muted)}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media (max-width:900px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .kpi{padding:14px;border-radius:16px;border:1px solid var(--border);background:rgba(255,255,255,.04)}
    .kpi .v{font-size:20px;font-weight:900}
    .kpi .t{font-size:12px;color:var(--muted);margin-top:2px}
    .tbl{width:100%;border-collapse:separate;border-spacing:0 10px}
    .tbl th{font-size:11px;color:var(--muted);text-align:left;padding:0 10px}
    .tbl td{padding:12px 10px;background:rgba(255,255,255,.04);border:1px solid var(--border)}
    .tbl tr td:first-child{border-radius:14px 0 0 14px}
    .tbl tr td:last-child{border-radius:0 14px 14px 0}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);background:rgba(0,0,0,.18);font-size:12px;color:var(--muted)}
    .chip.open{color:#bbf7d0;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
    .chip.closed{color:#fecaca;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
    .muted{color:var(--muted)}
    .footer{margin-top:18px;text-align:center;color:rgba(255,255,255,.6);font-size:12px}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .sectionTitle{font-weight:900;margin-bottom:8px}
    .hint{font-size:12px;color:var(--muted);line-height:1.5}

    /* Mobile: entries as cards */
    .entriesCards{display:none;gap:10px}
    .entryCard{border:1px solid var(--border);background:rgba(255,255,255,.04);border-radius:16px;padding:12px}
    .entryCard .name{font-weight:900}
    .entryCard .meta{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.45}
    @media(max-width:720px){
      .entriesTableWrap{display:none}
      .entriesCards{display:grid}
    }

    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
    .modal{width:min(560px,92vw);background:linear-gradient(180deg, rgba(18,29,58,.98), rgba(15,23,48,.98));
      border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    .modalHead{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border)}
    .modalHead b{font-weight:900}
    .modalBody{padding:16px;display:grid;gap:12px}
    .modalActions{padding:14px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .xbtn{background:rgba(255,255,255,.08);border:1px solid var(--border);color:var(--ink);border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:900}
    .gridForm2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:640px){.gridForm2{grid-template-columns:1fr}}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>AFCON Nights ‚Äî Owner Dashboard</h1>
          <div class="sub">Cairo timezone ‚Ä¢ RTDB</div>
        </div>
      </div>
      <div class="row">
        <button class="btn" id="pdfBtn">Export PDF</button>
        <button class="btn" id="csvBtn">Export CSV</button>
      </div>
    </div>

    <div class="grid2">
      <div class="card pad" id="exportArea">
        <div class="kpis">
          <div class="kpi"><div class="v" id="kTotal">0</div><div class="t">Total voters</div></div>
          <div class="kpi"><div class="v" id="kToday">0</div><div class="t">Today voters</div></div>
          <div class="kpi"><div class="v" id="kCorrect">0</div><div class="t">Correct picks (selected match)</div></div>
          <div class="kpi"><div class="v" id="kUnresolved">0</div><div class="t">Unresolved matches</div></div>
        </div>
        <div class="hr"></div>

        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <div class="sectionTitle">Matches & winners</div>
            <div class="hint">Filter by day, manage matches, then set winners for unresolved matches.</div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <div style="display:grid;gap:6px">
              <label>Day</label>
              <input class="inp" id="dayPick" type="date"/>
            </div>
            <button class="btn" id="loadDayBtn">Load</button>
            <button class="btn" id="loadAllBtn">All days</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px;align-items:flex-end">
          <div style="display:grid;gap:6px;flex:1;min-width:260px">
            <label>Flyer image URL (used by voting & winner screen)</label>
            <input class="inp" id="flyerUrl" placeholder="https://.../flyer.jpg or firebase storage url"/>
          </div>
          <button class="btn primary" id="saveFlyerBtn">Save</button>
        </div>

        <div class="hr"></div>

        <div class="row" style="gap:10px">
          <div class="chip" id="dayChip">Day: ‚Äî</div>
          <div class="chip" id="matchChip">Match: ‚Äî</div>
          <div class="chip" id="statusChip">Status: ‚Äî</div>
        </div>

        <div class="row" style="margin-top:10px">
          <select class="sel" id="unresolvedToggle" style="min-width:240px">
            <option value="unresolved">Unresolved matches only</option>
            <option value="all">All matches</option>
          </select>
          <select class="sel" id="matchSel" style="min-width:360px"></select>
          <select class="sel" id="winnerTeamSel" style="min-width:240px" disabled></select>
          <button class="btn good" id="setResultBtn" disabled>Set winner</button>
          <button class="btn" id="openWinnerBtn">Open winner screen</button>
        </div>

        <div class="hr"></div>

        <div class="card pad">
          <div class="sectionTitle">Manage matches</div>
          <div class="hint">Add, edit, or delete matches. Matches are saved in RTDB under the selected day.</div>
          <div class="hr"></div>

          <div class="gridForm2">
            <div class="row" style="display:grid;gap:6px">
              <label>Home team</label>
              <input class="inp" id="addHome" placeholder="e.g., Egypt"/>
            </div>
            <div class="row" style="display:grid;gap:6px">
              <label>Away team</label>
              <input class="inp" id="addAway" placeholder="e.g., Nigeria"/>
            </div>
          </div>

          <div class="gridForm2">
            <div class="row" style="display:grid;gap:6px">
              <label>Kickoff (Cairo)</label>
              <input class="inp" id="addKickoff" type="datetime-local"/>
            </div>
            <div class="row" style="display:grid;gap:6px">
              <label>Day (auto)</label>
              <input class="inp" id="addDay" type="date" disabled/>
            </div>
          </div>

          <div class="row" style="justify-content:flex-end">
            <button class="btn primary" id="addMatchBtn">Add match</button>
            <button class="btn" id="editMatchBtn" disabled>Edit selected</button>
            <button class="btn danger" id="deleteMatchBtn" disabled>Delete selected</button>
          </div>

          <div class="hint" id="matchCountHint" style="margin-top:10px"></div>
        </div>

        <div class="hr"></div>

        <div class="grid" style="gap:12px">
          <div class="card pad">
            <div class="sectionTitle">Votes over time (today)</div>
            <canvas id="chart" height="120"></canvas>
          </div>

          <div class="card pad">
            <div class="row" style="justify-content:space-between;align-items:flex-end">
              <div>
                <div class="sectionTitle">Entries</div>
                <div class="hint">Filter voters and export CSV/PDF.</div>
              </div>
              <div class="row">
                <select class="sel" id="filterMode" style="min-width:220px">
                  <option value="all">All</option>
                  <option value="today">Today only</option>
                  <option value="selectedMatch">Selected match only</option>
                  <option value="correctOnly">Correct only (selected match)</option>
                </select>
                <button class="btn" id="refreshBtn">Refresh</button>
              </div>
            </div>

            <div class="entriesTableWrap" style="overflow:auto;margin-top:10px">
              <table class="tbl" id="tbl">
                <thead>
                  <tr>
                    <th>Name</th><th>Phone</th><th>Email</th><th>Match</th><th>Pick</th><th>Time</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="entriesCards" id="entriesCards" style="margin-top:10px"></div>
          </div>

          <pre class="card pad" id="log" style="margin-top:12px;white-space:pre-wrap;max-height:220px;overflow:auto"></pre>
        </div>
      </div>

      <div class="card pad">
        <div class="sectionTitle">Quick checklist</div>
        <div class="hint" style="margin-top:6px;line-height:1.6">
          ‚Ä¢ Set the flyer URL (optional).<br/>
          ‚Ä¢ Add matches manually (or edit/delete).<br/>
          ‚Ä¢ Select unresolved match ‚Üí set winner.<br/>
          ‚Ä¢ Winner screen draws from correct picks only (after winner set).<br/>
        </div>
        <div class="hr"></div>
        <div class="sectionTitle">Data paths</div>
        <div class="hint" style="margin-top:6px;line-height:1.6">
          afconApp/config/flyerUrl<br/>
          afconApp/cache/matchesByDate/YYYY-MM-DD/matches[]<br/>
          afconApp/entries/*<br/>
          afconApp/results/matchId = winnerTeam<br/>
        </div>
        <div class="footer">Powered by Luma</div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <b id="modalTitle">Edit match</b>
        <button class="xbtn" id="modalClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="gridForm2">
          <div style="display:grid;gap:6px">
            <label>Home team</label>
            <input class="inp" id="mHome"/>
          </div>
          <div style="display:grid;gap:6px">
            <label>Away team</label>
            <input class="inp" id="mAway"/>
          </div>
        </div>
        <div class="gridForm2">
          <div style="display:grid;gap:6px">
            <label>Kickoff (Cairo)</label>
            <input class="inp" id="mKick" type="datetime-local"/>
          </div>
          <div style="display:grid;gap:6px">
            <label>Match ID</label>
            <input class="inp" id="mId" disabled/>
          </div>
        </div>
        <div class="hint">Editing updates the match in its day list.</div>
      </div>
      <div class="modalActions">
        <button class="btn" id="modalCancel">Cancel</button>
        <button class="btn primary" id="modalSave">Save changes</button>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
  authDomain: "events-339ce.firebaseapp.com",
  databaseURL: "https://events-339ce-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "events-339ce",
  storageBucket: "events-339ce.appspot.com",
  messagingSenderId: "175601544315",
  appId: "1:175601544315:web:00c94b4affa972b3a286de"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const APP_PATH = "afconApp";
const TZ = "Africa/Cairo";
const VOTE_WINDOW_MS = (2*60+3)*60*1000;

const logEl = document.getElementById("log");
const log = (s) => { logEl.textContent = (new Date().toLocaleString() + "  " + s + "\\n") + logEl.textContent; };

const todayKeyCairo = () => new Intl.DateTimeFormat('en-CA', {timeZone:TZ, year:'numeric', month:'2-digit', day:'2-digit'}).format(new Date());
const fmtTime = (iso) => new Intl.DateTimeFormat('en-US', {timeZone:TZ, hour:'2-digit', minute:'2-digit'}).format(new Date(iso));
const fmtDate = (iso) => new Intl.DateTimeFormat('en-CA', {timeZone:TZ, year:'numeric', month:'2-digit', day:'2-digit'}).format(new Date(iso));

function cutoffMs(iso){ return new Date(iso).getTime() + VOTE_WINDOW_MS; }

function makeId(){
  return "M_" + Math.random().toString(16).slice(2,8).toUpperCase() + "_" + Date.now().toString(36).toUpperCase();
}

// Convert datetime-local (YYYY-MM-DDTHH:mm) to Cairo ISO with +02:00 offset
function toCairoIso(dtLocal){
  // treat the provided datetime-local as Cairo local wall time
  // produce ISO string with explicit +02:00 offset
  if(!dtLocal) return null;
  const [datePart, timePart] = dtLocal.split("T");
  if(!datePart || !timePart) return null;
  return `${datePart}T${timePart}:00+02:00`;
}

// Convert Cairo ISO to datetime-local string
function isoToLocalInput(iso){
  try{
    const d = new Date(iso);
    // format in Cairo timezone
    const parts = new Intl.DateTimeFormat('en-CA', { timeZone:TZ, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false }).formatToParts(d);
    const getp = (t)=>parts.find(p=>p.type===t)?.value;
    const y=getp("year"), m=getp("month"), da=getp("day"), hh=getp("hour"), mm=getp("minute");
    return `${y}-${m}-${da}T${hh}:${mm}`;
  }catch{ return ""; }
}

function normalizeMatch(input){
  const id = String(input.id || makeId());
  const home = String(input.home || "").trim();
  const away = String(input.away || "").trim();
  const kickoffIso = String(input.kickoffIso || "").trim();
  if(!home || !away) throw new Error("Home/Away required");
  if(!kickoffIso) throw new Error("Kickoff required");
  const dayKey = fmtDate(kickoffIso);
  const time = fmtTime(kickoffIso);
  const label = `${home} vs ${away} ‚Äî ${time}`;
  return {
    id, home, away, kickoffIso,
    dayKey, time, label,
    cutoff: cutoffMs(kickoffIso)
  };
}

async function saveFlyer(){
  const url = document.getElementById("flyerUrl").value.trim();
  await set(ref(db, `${APP_PATH}/config/flyerUrl`), url || "");
  log("Saved flyer URL.");
}

let chart;
function renderChart(entries){
  const day = todayKeyCairo();
  const todays = entries.filter(e => (e.createdDayKey || e.dayKey) === day);
  const buckets = new Array(24).fill(0);
  todays.forEach(e => {
    const tms = (typeof e.createdAt === "number") ? e.createdAt : Date.parse(e.createdAtIso || "");
    if(!tms) return;
    const hh = parseInt(new Intl.DateTimeFormat('en-US', {timeZone:TZ, hour:'2-digit', hour12:false}).format(new Date(tms)),10);
    if(!Number.isNaN(hh)) buckets[hh] += 1;
  });
  const labels = buckets.map((_,i)=> String(i).padStart(2,'0')+":00");
  const ctx = document.getElementById("chart").getContext("2d");
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets: [{ label: "Votes", data: buckets, tension: 0.25 }] },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: "#a7b0d6" } },
        y: { ticks: { color: "#a7b0d6" } }
      }
    }
  });
}

let allEntries = [];
let currentDay = todayKeyCairo();
let dayMatches = [];
let allMatchesFlat = [];
let selectedMatch = null;
let resultsMap = {};
let loadedMode = "day"; // "day" or "all"

async function loadResults(){
  const snap = await get(ref(db, `${APP_PATH}/results`));
  resultsMap = snap.exists() ? snap.val() : {};
}

async function loadEntries(){
  const snap = await get(ref(db, `${APP_PATH}/entries`));
  const v = snap.exists() ? snap.val() : {};
  allEntries = Object.entries(v).map(([id,e]) => ({...e, _id:id}));
  document.getElementById("kTotal").textContent = allEntries.length;

  const tday = todayKeyCairo();
  const todayCount = allEntries.filter(e => (e.createdDayKey || e.dayKey) === tday).length;
  document.getElementById("kToday").textContent = todayCount;

  renderChart(allEntries);
}

function computeOpenClosed(m){
  const st = (Date.now() >= (m.cutoff || cutoffMs(m.kickoffIso))) ? "Closed" : "Open";
  return st;
}

function setUnresolvedKpi(){
  const unresolved = allMatchesFlat.filter(m => !resultsMap?.[m.id]).length;
  document.getElementById("kUnresolved").textContent = String(unresolved);
}

function setKpiCorrect(){
  const el = document.getElementById("kCorrect");
  if(!selectedMatch) { el.textContent = "0"; return; }
  const winner = resultsMap?.[selectedMatch.id] || null;
  if(!winner) { el.textContent = "0"; return; }
  const correct = allEntries.filter(e => e.matchId === selectedMatch.id && e.pickedTeam === winner);
  el.textContent = String(correct.length);
}

function renderEntries(){
  const mode = document.getElementById("filterMode").value;
  let rows = allEntries.slice();
  const tday = todayKeyCairo();

  if(mode === "today") rows = rows.filter(e => (e.createdDayKey || e.dayKey) === tday);
  if(mode === "selectedMatch" && selectedMatch) rows = rows.filter(e => e.matchId === selectedMatch.id);
  if(mode === "correctOnly" && selectedMatch) {
    const winner = resultsMap?.[selectedMatch.id];
    rows = winner ? rows.filter(e => e.matchId === selectedMatch.id && e.pickedTeam === winner) : [];
  }
  rows.sort((a,b)=> ( (b.createdAt||0) - (a.createdAt||0) ));

  // table (desktop)
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML = "";
  rows.slice(0, 500).forEach(e => {
    const tr = document.createElement("tr");
    const tms = (typeof e.createdAt === "number") ? e.createdAt : Date.parse(e.createdAtIso || "");
    const time = tms ? new Intl.DateTimeFormat('en-US', {timeZone:TZ, hour:'2-digit', minute:'2-digit', day:'2-digit', month:'short'}).format(new Date(tms)) : "‚Äî";
    tr.innerHTML = `
      <td>${(e.fullName||"‚Äî")}</td>
      <td>${(e.phone||"‚Äî")}</td>
      <td>${(e.email||"‚Äî")}</td>
      <td>${(e.matchLabel||e.matchId||"‚Äî")}</td>
      <td>${(e.pickedTeam||"‚Äî")}</td>
      <td>${time}</td>
    `;
    tb.appendChild(tr);
  });

  // cards (mobile)
  const cards = document.getElementById("entriesCards");
  cards.innerHTML = "";
  rows.slice(0, 200).forEach(e => {
    const div = document.createElement("div");
    div.className = "entryCard";
    const tms = (typeof e.createdAt === "number") ? e.createdAt : Date.parse(e.createdAtIso || "");
    const time = tms ? new Intl.DateTimeFormat('en-US', {timeZone:TZ, hour:'2-digit', minute:'2-digit', day:'2-digit', month:'short'}).format(new Date(tms)) : "‚Äî";
    div.innerHTML = `
      <div class="name">${(e.fullName||"‚Äî")}</div>
      <div class="meta">
        <div>üìû ${(e.phone||"‚Äî")} ‚Ä¢ ‚úâÔ∏è ${(e.email||"‚Äî")}</div>
        <div>üèüÔ∏è ${(e.matchLabel||e.matchId||"‚Äî")}</div>
        <div>‚úÖ Pick: <b>${(e.pickedTeam||"‚Äî")}</b> ‚Ä¢ ‚è±Ô∏è ${time}</div>
      </div>
    `;
    cards.appendChild(div);
  });
}

async function readDayMatches(dayKey){
  const snap = await get(ref(db, `${APP_PATH}/cache/matchesByDate/${dayKey}/matches`));
  const arr = snap.exists() ? (snap.val() || []) : [];
  return Array.isArray(arr) ? arr : [];
}

async function writeDayMatches(dayKey, arr){
  await set(ref(db, `${APP_PATH}/cache/matchesByDate/${dayKey}/matches`), arr);
  await update(ref(db, `${APP_PATH}/cache/matchesByDate/${dayKey}`), { fetchedAt: Date.now() });
}

function refreshMatchCountHint(){
  const hint = document.getElementById("matchCountHint");
  const list = (loadedMode === "all") ? allMatchesFlat : dayMatches;
  hint.textContent = list.length ? `Loaded matches: ${list.length}` : "No matches loaded yet.";
}

async function loadDay(dayKey){
  loadedMode = "day";
  currentDay = dayKey;
  document.getElementById("dayChip").textContent = `Day: ${dayKey}`;
  dayMatches = await readDayMatches(dayKey);
  dayMatches.sort((a,b)=> new Date(a.kickoffIso) - new Date(b.kickoffIso));
  allMatchesFlat = dayMatches.slice();

  populateMatchSelect();
  refreshMatchCountHint();
  setUnresolvedKpi();
  setKpiCorrect();
  renderEntries();
}

async function loadAllDays(){
  loadedMode = "all";
  document.getElementById("dayChip").textContent = `Day: All`;
  const snap = await get(ref(db, `${APP_PATH}/cache/matchesByDate`));
  const root = snap.exists() ? (snap.val() || {}) : {};
  const flat = [];
  Object.keys(root).forEach(dayKey => {
    const arr = root?.[dayKey]?.matches;
    if(Array.isArray(arr)) {
      arr.forEach(m => flat.push({ ...m, dayKey: m.dayKey || dayKey }));
    }
  });
  flat.sort((a,b)=> new Date(a.kickoffIso) - new Date(b.kickoffIso));
  allMatchesFlat = flat;
  dayMatches = [];
  populateMatchSelect();
  refreshMatchCountHint();
  setUnresolvedKpi();
  setKpiCorrect();
  renderEntries();
}

function populateMatchSelect(){
  const toggle = document.getElementById("unresolvedToggle").value;
  const sel = document.getElementById("matchSel");
  sel.innerHTML = "";

  const list = (loadedMode === "all") ? allMatchesFlat : allMatchesFlat; // (same variable)
  let filtered = list.slice();
  if(toggle === "unresolved") filtered = filtered.filter(m => !resultsMap?.[m.id]);

  if(!filtered.length){
    const o = document.createElement("option");
    o.value = "";
    o.textContent = (toggle === "unresolved") ? "No unresolved matches" : "No matches loaded";
    sel.appendChild(o);
    sel.disabled = true;
    selectedMatch = null;
    onSelectMatch(null);
    return;
  }

  sel.disabled = false;
  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = "Select a match‚Ä¶";
  sel.appendChild(ph);

  filtered.forEach(m => {
    const o = document.createElement("option");
    o.value = m.id;
    const day = m.dayKey || fmtDate(m.kickoffIso);
    o.textContent = (loadedMode === "all") ? `[${day}] ${m.label || (m.home+" vs "+m.away+" ‚Äî "+fmtTime(m.kickoffIso))}` : (m.label || (m.home+" vs "+m.away+" ‚Äî "+fmtTime(m.kickoffIso)));
    sel.appendChild(o);
  });

  // auto-select first real item
  sel.value = filtered[0].id;
  onSelectMatch(filtered[0].id);
}

function onSelectMatch(matchId){
  selectedMatch = matchId ? allMatchesFlat.find(m => String(m.id) === String(matchId)) : null;

  document.getElementById("matchChip").textContent = selectedMatch ? `Match: ${selectedMatch.home} vs ${selectedMatch.away}` : "Match: ‚Äî";
  const st = selectedMatch ? computeOpenClosed(selectedMatch) : "‚Äî";
  const chip = document.getElementById("statusChip");
  chip.textContent = `Status: ${st}`;
  chip.className = "chip " + (st==="Open"?"open":(st==="Closed"?"closed":""));

  // winner select
  const ws = document.getElementById("winnerTeamSel");
  ws.innerHTML = "";
  if(!selectedMatch){
    ws.disabled = true;
    document.getElementById("setResultBtn").disabled = true;
  } else {
    [selectedMatch.home, selectedMatch.away].forEach(t => {
      const o = document.createElement("option");
      o.value = t; o.textContent = t;
      ws.appendChild(o);
    });
    ws.disabled = false;
    document.getElementById("setResultBtn").disabled = false;
    const already = resultsMap?.[selectedMatch.id];
    if(already) ws.value = already;
  }

  document.getElementById("editMatchBtn").disabled = !selectedMatch;
  document.getElementById("deleteMatchBtn").disabled = !selectedMatch;

  setKpiCorrect();
  renderEntries();

  // sync addDay preview
  if(selectedMatch?.kickoffIso){
    document.getElementById("addDay").value = fmtDate(selectedMatch.kickoffIso);
  }
}

async function setResult(){
  if(!selectedMatch) return;
  const winner = document.getElementById("winnerTeamSel").value;
  await set(ref(db, `${APP_PATH}/results/${selectedMatch.id}`), winner);
  resultsMap[selectedMatch.id] = winner;
  log(`Set winner for ${selectedMatch.id} = ${winner}`);
  setUnresolvedKpi();
  setKpiCorrect();
  populateMatchSelect();
  renderEntries();
}

function openWinner(){
  const hash = selectedMatch ? `#day=${encodeURIComponent(selectedMatch.dayKey || currentDay)}&match=${encodeURIComponent(selectedMatch.id)}` : "";
  window.open("winner_v3.html"+hash, "_blank");
}

async function exportCSV(){
  const mode = document.getElementById("filterMode").value;
  let rows = allEntries.slice();
  const tday = todayKeyCairo();
  if(mode === "today") rows = rows.filter(e => (e.createdDayKey || e.dayKey) === tday);
  if(mode === "selectedMatch" && selectedMatch) rows = rows.filter(e => e.matchId === selectedMatch.id);
  if(mode === "correctOnly" && selectedMatch) {
    const winner = resultsMap?.[selectedMatch.id];
    rows = winner ? rows.filter(e => e.matchId === selectedMatch.id && e.pickedTeam === winner) : [];
  }
  const header = ["fullName","phone","email","matchId","matchLabel","pickedTeam","dayKey","createdDayKey","kickoffIso","createdAt"];
  const csv = [header.join(",")].concat(rows.map(r => header.map(k => JSON.stringify(r[k] ?? "")).join(","))).join("\\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `afcon_entries_${mode}_${todayKeyCairo()}.csv`;
  a.click();
}

async function exportPDF(){
  const area = document.getElementById("exportArea");
  const canvas = await html2canvas(area, {scale:2, backgroundColor:null});
  const img = canvas.toDataURL("image/png");
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({orientation:"p", unit:"pt", format:"a4"});
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const ratio = Math.min(pageW/canvas.width, pageH/canvas.height);
  const w = canvas.width * ratio;
  const h = canvas.height * ratio;
  pdf.addImage(img, "PNG", (pageW-w)/2, 18, w, h);
  pdf.save(`afcon_dashboard_${todayKeyCairo()}.pdf`);
}

async function addMatch(){
  const home = document.getElementById("addHome").value.trim();
  const away = document.getElementById("addAway").value.trim();
  const dtLocal = document.getElementById("addKickoff").value;
  if(!home || !away || !dtLocal){ alert("Please fill home, away, and kickoff."); return; }

  const kickoffIso = toCairoIso(dtLocal);
  const m = normalizeMatch({ home, away, kickoffIso });
  const dk = m.dayKey;

  // load that day array, append, write back
  const arr = await readDayMatches(dk);
  const exists = arr.some(x => String(x.id) === String(m.id));
  if(exists){ alert("Match ID collision. Try again."); return; }
  arr.push(m);
  arr.sort((a,b)=> new Date(a.kickoffIso) - new Date(b.kickoffIso));
  await writeDayMatches(dk, arr);

  log(`Added match [${dk}] ${m.label} (${m.id})`);

  // reload view
  document.getElementById("addHome").value = "";
  document.getElementById("addAway").value = "";
  document.getElementById("addKickoff").value = "";
  document.getElementById("addDay").value = "";

  if(loadedMode === "all") await loadAllDays();
  else await loadDay(dk);
}

async function deleteSelectedMatch(){
  if(!selectedMatch) return;
  const ok = confirm(`Delete match?\\n\\n${selectedMatch.label || (selectedMatch.home+" vs "+selectedMatch.away)}\\nID: ${selectedMatch.id}`);
  if(!ok) return;

  const dk = selectedMatch.dayKey || fmtDate(selectedMatch.kickoffIso);
  const arr = await readDayMatches(dk);
  const next = arr.filter(m => String(m.id) !== String(selectedMatch.id));
  await writeDayMatches(dk, next);
  log(`Deleted match ${selectedMatch.id} from day ${dk}.`);

  if(loadedMode === "all") await loadAllDays();
  else await loadDay(dk);
}

function openEditModal(){
  if(!selectedMatch) return;
  document.getElementById("mHome").value = selectedMatch.home || "";
  document.getElementById("mAway").value = selectedMatch.away || "";
  document.getElementById("mKick").value = isoToLocalInput(selectedMatch.kickoffIso);
  document.getElementById("mId").value = selectedMatch.id || "";
  showModal(true);
}

function showModal(on){
  const back = document.getElementById("modalBack");
  back.style.display = on ? "flex" : "none";
}

async function saveEditModal(){
  if(!selectedMatch) return;

  const home = document.getElementById("mHome").value.trim();
  const away = document.getElementById("mAway").value.trim();
  const dtLocal = document.getElementById("mKick").value;
  if(!home || !away || !dtLocal){ alert("Please fill home, away, and kickoff."); return; }

  const kickoffIso = toCairoIso(dtLocal);
  const updated = normalizeMatch({ id: selectedMatch.id, home, away, kickoffIso });

  const oldDay = selectedMatch.dayKey || fmtDate(selectedMatch.kickoffIso);
  const newDay = updated.dayKey;

  if(oldDay === newDay){
    const arr = await readDayMatches(oldDay);
    const next = arr.map(m => (String(m.id)===String(updated.id)) ? updated : m);
    next.sort((a,b)=> new Date(a.kickoffIso) - new Date(b.kickoffIso));
    await writeDayMatches(oldDay, next);
  } else {
    // remove from old day, add to new day
    const oldArr = await readDayMatches(oldDay);
    const oldNext = oldArr.filter(m => String(m.id) !== String(updated.id));
    await writeDayMatches(oldDay, oldNext);

    const newArr = await readDayMatches(newDay);
    newArr.push(updated);
    newArr.sort((a,b)=> new Date(a.kickoffIso) - new Date(b.kickoffIso));
    await writeDayMatches(newDay, newArr);
  }

  log(`Edited match ${updated.id} (moved day ${oldDay} ‚Üí ${newDay}).`);

  showModal(false);
  if(loadedMode === "all") await loadAllDays();
  else await loadDay(newDay);
}

document.getElementById("saveFlyerBtn").addEventListener("click", saveFlyer);
document.getElementById("loadDayBtn").addEventListener("click", () => {
  const v = document.getElementById("dayPick").value;
  if(!v) return;
  loadDay(v);
});
document.getElementById("loadAllBtn").addEventListener("click", loadAllDays);
document.getElementById("unresolvedToggle").addEventListener("change", populateMatchSelect);
document.getElementById("matchSel").addEventListener("change", (e)=> onSelectMatch(e.target.value));
document.getElementById("setResultBtn").addEventListener("click", setResult);
document.getElementById("openWinnerBtn").addEventListener("click", openWinner);
document.getElementById("refreshBtn").addEventListener("click", async ()=>{ await loadResults(); await loadEntries(); setUnresolvedKpi(); setKpiCorrect(); populateMatchSelect(); renderEntries(); });
document.getElementById("csvBtn").addEventListener("click", exportCSV);
document.getElementById("pdfBtn").addEventListener("click", exportPDF);

document.getElementById("addMatchBtn").addEventListener("click", addMatch);
document.getElementById("editMatchBtn").addEventListener("click", openEditModal);
document.getElementById("deleteMatchBtn").addEventListener("click", deleteSelectedMatch);

// kickoff -> auto day preview
document.getElementById("addKickoff").addEventListener("change", () => {
  const dt = document.getElementById("addKickoff").value;
  const iso = toCairoIso(dt);
  if(iso) document.getElementById("addDay").value = fmtDate(iso);
});

document.getElementById("modalClose").addEventListener("click", ()=>showModal(false));
document.getElementById("modalCancel").addEventListener("click", ()=>showModal(false));
document.getElementById("modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") showModal(false); });
document.getElementById("modalSave").addEventListener("click", saveEditModal);

(async function init(){
  document.getElementById("dayPick").value = todayKeyCairo();

  // load flyer url
  const f = await get(ref(db, `${APP_PATH}/config/flyerUrl`));
  if(f.exists()) document.getElementById("flyerUrl").value = f.val() || "";

  await loadResults();
  await loadEntries();
  await loadDay(todayKeyCairo());
})();
</script>

</body>
</html>
