<!doctype html>
<html lang="en">
<head>
  <title>AFCON Nights — Owner Dashboard</title>
  
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1730;
      --panel2:#121d3a;
      --ink:#eef2ff;
      --muted:#a7b0d6;
      --border:rgba(255,255,255,.10);
      --accent:#7c3aed;
      --accent2:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --radius:18px;
      --shadow:0 22px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:
      radial-gradient(1200px 700px at 10% -10%, rgba(124,58,237,.35), transparent 60%),
      radial-gradient(900px 600px at 110% 10%, rgba(34,197,94,.25), transparent 55%),
      radial-gradient(900px 700px at 50% 120%, rgba(59,130,246,.18), transparent 55%),
      var(--bg);
      color:var(--ink);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;gap:10px;align-items:center}
    .dot{width:12px;height:12px;border-radius:999px;background:linear-gradient(135deg,var(--accent),#60a5fa)}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .grid{display:grid;gap:14px}
    .grid2{display:grid;grid-template-columns:1.4fr .9fr;gap:14px}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}}
    .pad{padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--ink);
      padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:700}
    .btn:hover{background:rgba(255,255,255,.09)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#3b82f6);border-color:transparent}
    .btn.good{background:linear-gradient(135deg,#16a34a,#22c55e);border-color:transparent}
    .btn.danger{background:linear-gradient(135deg,#ef4444,#f97316);border-color:transparent}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .inp,.sel,textarea{background:rgba(0,0,0,.18);border:1px solid var(--border);color:var(--ink);
      padding:10px 12px;border-radius:14px;outline:none;min-width:220px}
    textarea{min-width:unset;width:100%;min-height:92px;resize:vertical}
    label{font-size:12px;color:var(--muted)}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media (max-width:900px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .kpi{padding:14px;border-radius:16px;border:1px solid var(--border);background:rgba(255,255,255,.04)}
    .kpi .v{font-size:20px;font-weight:800}
    .kpi .t{font-size:12px;color:var(--muted);margin-top:2px}
    .tbl{width:100%;border-collapse:separate;border-spacing:0 10px}
    .tbl th{font-size:11px;color:var(--muted);text-align:left;padding:0 10px}
    .tbl td{padding:12px 10px;background:rgba(255,255,255,.04);border:1px solid var(--border)}
    .tbl tr td:first-child{border-radius:14px 0 0 14px}
    .tbl tr td:last-child{border-radius:0 14px 14px 0}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);background:rgba(0,0,0,.18);font-size:12px;color:var(--muted)}
    .chip.open{color:#bbf7d0;border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
    .chip.closed{color:#fecaca;border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.12)}
    .muted{color:var(--muted)}
    .footer{margin-top:18px;text-align:center;color:rgba(255,255,255,.6);font-size:12px}
    .hr{height:1px;background:var(--border);margin:12px 0}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>AFCON Nights — Owner Dashboard</h1>
          <div class="sub">Cairo timezone • RTDB • Manage matches, votes, winners, exports</div>
        </div>
      </div>
      <div class="row">
        <button class="btn" id="pdfBtn">Export PDF</button>
        <button class="btn" id="csvBtn">Export CSV</button>
      </div>
    </div>

    <div class="grid2">
      <div class="card pad" id="exportArea">
        <div class="kpis">
          <div class="kpi"><div class="v" id="kTotal">0</div><div class="t">Total voters</div></div>
          <div class="kpi"><div class="v" id="kToday">0</div><div class="t">Today voters</div></div>
          <div class="kpi"><div class="v" id="kCorrect">0</div><div class="t">Correct picks (selected match)</div></div>
          <div class="kpi"><div class="v" id="kApi">0</div><div class="t">API calls today (manual)</div></div>
        </div>
        <div class="hr"></div>

        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:900">Matches</div>
            <div class="muted" id="mNote">Import fixtures once, then everything runs from RTDB.</div>
          </div>
          <div class="row">
            <input class="inp" id="dayPick" type="date"/>
            <button class="btn" id="loadDayBtn">Load day</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <label style="min-width:200px">Flyer image URL (used by index & winner)</label>
          <input class="inp" id="flyerUrl" placeholder="https://.../flyer.jpg or firebase storage url"/>
          <button class="btn primary" id="saveFlyerBtn">Save</button>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="chip" id="dayChip">Day: —</div>
          <div class="chip" id="matchChip">Match: —</div>
          <div class="chip" id="statusChip">Status: —</div>
        </div>

        <div class="row" style="margin-top:10px;flex-wrap:wrap">
          <select class="sel" id="matchSel" style="min-width:360px"></select>
          <select class="sel" id="winnerTeamSel" style="min-width:240px" disabled></select>
          <button class="btn good" id="setResultBtn" disabled>Set result</button>
          <button class="btn" id="openWinnerBtn">Open winner screen</button>
        </div>

        <div class="hr"></div>

        <div class="grid" style="gap:12px">
          <div class="card pad">
            <div style="font-weight:900;margin-bottom:8px">Votes over time (today)</div>
            <canvas id="chart" height="120"></canvas>
          </div>

          <div class="card pad">
            <div class="row" style="justify-content:space-between">
              <div style="font-weight:900">Entries (filtered)</div>
              <div class="row">
                <select class="sel" id="filterMode" style="min-width:220px">
                  <option value="all">All</option>
                  <option value="today">Today only</option>
                  <option value="selectedMatch">Selected match only</option>
                  <option value="correctOnly">Correct only (selected match)</option>
                </select>
                <button class="btn" id="refreshBtn">Refresh</button>
              </div>
            </div>
            <div style="overflow:auto;margin-top:10px">
              <table class="tbl" id="tbl">
                <thead>
                  <tr>
                    <th>Name</th><th>Phone</th><th>Email</th><th>Match</th><th>Pick</th><th>Time</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="card pad">
            <div style="font-weight:900;margin-bottom:8px">Import fixtures (recommended)</div>
            <div class="muted" style="margin-bottom:10px">
              Since your API plan only returns up to 2023, import AFCON fixtures once (JSON or CSV), store in RTDB, and everything runs from there.
            </div>

            <div class="row" style="align-items:flex-end">
              <div style="flex:1;min-width:260px">
                <label>Upload JSON (array of matches)</label>
                <input class="inp" type="file" id="jsonFile" accept="application/json"/>
              </div>
              <div style="flex:1;min-width:260px">
                <label>Upload CSV</label>
                <input class="inp" type="file" id="csvFile" accept=".csv,text/csv"/>
              </div>
              <button class="btn primary" id="importBtn">Import</button>
              <button class="btn" id="templateBtn">Show template</button>
            </div>

            <div class="hr"></div>
            <div class="row">
              <button class="btn" id="rebuildTodayBtn">Rebuild today cache</button>
              <button class="btn danger" id="clearCacheBtn">Clear match cache</button>
            </div>

            <pre class="card pad" id="log" style="margin-top:12px;white-space:pre-wrap;max-height:260px;overflow:auto"></pre>
          </div>
        </div>
      </div>

      <div class="card pad">
        <div style="font-weight:900">How to use</div>
        <div class="muted" style="margin-top:6px;line-height:1.6">
          1) Paste Firebase config.<br/>
          2) Set Flyer URL (optional).<br/>
          3) Import fixtures (JSON/CSV).<br/>
          4) Load a day and select a match.<br/>
          5) Set the result winner team after the match.<br/>
          6) Winner screen will pick random from correct voters only.<br/>
        </div>
        <div class="hr"></div>
        <div style="font-weight:900">Data nodes</div>
        <div class="muted" style="margin-top:6px;line-height:1.6">
          afconApp/config/flyerUrl<br/>
          afconApp/cache/matchesByDate/YYYY-MM-DD/matches[]<br/>
          afconApp/entries/*<br/>
          afconApp/results/matchId = winnerTeam<br/>
          afconApp/winners/* (draw log)<br/>
        </div>
        <div class="footer">Powered by Luma</div>
      </div>
    </div>
  </div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getDatabase, ref, set, get, update, push, child, onValue, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

// TODO: Paste your Firebase config (same "events one" config you use everywhere)
const firebaseConfig = {
      apiKey: "AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
      authDomain: "events-339ce.firebaseapp.com",
      databaseURL: "https://events-339ce-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "events-339ce",
      storageBucket: "events-339ce.appspot.com",
      messagingSenderId: "175601544315",
      appId: "1:175601544315:web:00c94b4affa972b3a286de"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const APP_PATH = "afconApp";

const logEl = document.getElementById("log");
const log = (s) => { logEl.textContent = (new Date().toLocaleString() + "  " + s + "\n") + logEl.textContent; };

const todayKeyCairo = () => new Intl.DateTimeFormat('en-CA', {timeZone:'Africa/Cairo', year:'numeric', month:'2-digit', day:'2-digit'}).format(new Date());
const fmtTime = (iso) => new Intl.DateTimeFormat('en-US', {timeZone:'Africa/Cairo', hour:'2-digit', minute:'2-digit'}).format(new Date(iso));
const fmtDate = (iso) => new Intl.DateTimeFormat('en-CA', {timeZone:'Africa/Cairo', year:'numeric', month:'2-digit', day:'2-digit'}).format(new Date(iso));

const cutoffMs = (iso) => new Date(iso).getTime() + (2*60*60 + 3*60)*1000;

function normalizeMatch(m) {
  // accepts already-normalized object or raw import schema
  const id = String(m.id ?? m.matchId ?? m.fixtureId ?? m._id ?? crypto.randomUUID());
  const kickoffIso = m.kickoffIso ?? m.kickoff ?? m.dateIso ?? m.date ?? m.startIso;
  if(!kickoffIso) throw new Error("Missing kickoffIso/date in match: " + JSON.stringify(m).slice(0,120));
  const home = m.home ?? m.homeTeam ?? m.team1 ?? m.localteam ?? m.home_name;
  const away = m.away ?? m.awayTeam ?? m.team2 ?? m.visitorteam ?? m.away_name;
  if(!home || !away) throw new Error("Missing home/away in match: " + JSON.stringify(m).slice(0,120));

  const dayKey = fmtDate(kickoffIso);
  const time = fmtTime(kickoffIso);
  const label = `${home} vs ${away} — ${time}`;
  const cutoff = cutoffMs(kickoffIso);

  return {
    id, home, away, kickoffIso,
    dayKey, time, label, cutoff
  };
}

function parseCSV(text) {
  // simple CSV parser (comma separated, with optional quotes)
  const lines = text.split(/\r?\n/).filter(l => l.trim().length);
  if(lines.length < 2) return [];
  const header = lines[0].split(",").map(h => h.trim());
  const idx = (name) => header.findIndex(h => h.toLowerCase() === name.toLowerCase());
  const getv = (cells,i)=> (i>=0 && i<cells.length) ? cells[i] : "";
  const out = [];
  for(let i=1;i<lines.length;i++) {
    const cells = [];
    let cur="", inQ=false;
    for(let c=0;c<lines[i].length;c++) {
      const ch = lines[i][c];
      if(ch === '"' ) {
        if(inQ && lines[i][c+1] === '"') { cur+='"'; c++; }
        else inQ = !inQ;
      } else if(ch === ',' && !inQ) {
        cells.push(cur); cur="";
      } else cur += ch;
    }
    cells.push(cur);
    const obj = {
      id: getv(cells, idx("id")) || getv(cells, idx("matchId")),
      home: getv(cells, idx("home")),
      away: getv(cells, idx("away")),
      kickoffIso: getv(cells, idx("kickoffIso")) || getv(cells, idx("kickoff")) || getv(cells, idx("date")),
    };
    if(obj.home && obj.away && obj.kickoffIso) out.push(obj);
  }
  return out;
}

async function saveFlyer() {
  const url = document.getElementById("flyerUrl").value.trim();
  await set(ref(db, `${APP_PATH}/config/flyerUrl`), url || "");
  log("Saved flyer URL.");
}

async function clearMatchCache() {
  await set(ref(db, `${APP_PATH}/cache/matchesByDate`), null);
  log("Cleared match cache.");
}

async function rebuildToday() {
  const day = todayKeyCairo();
  const snap = await get(ref(db, `${APP_PATH}/cache/matchesByDate/${day}/matches`));
  const matches = snap.exists() ? snap.val() : [];
  await set(ref(db, `${APP_PATH}/cache/todayMatches/${day}`), { fetchedAt: Date.now(), matches });
  log(`Rebuilt today cache for ${day} (count=${matches.length}).`);
}

async function importFixtures() {
  const jf = document.getElementById("jsonFile").files?.[0];
  const cf = document.getElementById("csvFile").files?.[0];
  if(!jf && !cf) { alert("Upload JSON or CSV first."); return; }

  let raw = [];
  if(jf) {
    const txt = await jf.text();
    const parsed = JSON.parse(txt);
    raw = Array.isArray(parsed) ? parsed : (parsed.matches || parsed.response || []);
  } else {
    const txt = await cf.text();
    raw = parseCSV(txt);
  }

  if(!raw.length) { alert("No matches found in file."); return; }

  const byDate = new Map();
  let ok=0, bad=0;
  raw.forEach(r => {
    try {
      const m = normalizeMatch(r);
      if(!byDate.has(m.dayKey)) byDate.set(m.dayKey, []);
      byDate.get(m.dayKey).push(m);
      ok++;
    } catch(e) {
      bad++;
      console.warn(e);
    }
  });

  // sort & write
  for(const [dayKey, arr] of byDate.entries()) {
    arr.sort((a,b)=> new Date(a.kickoffIso) - new Date(b.kickoffIso));
    await set(ref(db, `${APP_PATH}/cache/matchesByDate/${dayKey}`), {
      fetchedAt: Date.now(),
      matches: arr
    });
  }
  log(`Imported fixtures: ok=${ok}, bad=${bad}, days=${byDate.size}.`);
  await rebuildToday();
  await loadDay(todayKeyCairo());
}

let chart;
function renderChart(entries) {
  const day = todayKeyCairo();
  const todays = entries.filter(e => e.dayKey === day);
  // bucket by hour Cairo
  const buckets = new Array(24).fill(0);
  todays.forEach(e => {
    const d = new Date(e.createdAt || Date.parse(e.createdAtIso));
    const hh = parseInt(new Intl.DateTimeFormat('en-US', {timeZone:'Africa/Cairo', hour:'2-digit', hour12:false}).format(d),10);
    if(!Number.isNaN(hh)) buckets[hh] += 1;
  });
  const labels = buckets.map((_,i)=> String(i).padStart(2,'0')+":00");
  const data = buckets;
  const ctx = document.getElementById("chart").getContext("2d");
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{ label: "Votes", data, tension: 0.25 }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: "#a7b0d6" } },
        y: { ticks: { color: "#a7b0d6" } }
      }
    }
  });
}

let allEntries = [];
let currentDay = todayKeyCairo();
let dayMatches = [];
let selectedMatch = null;
let resultsMap = {};

async function loadResults() {
  const snap = await get(ref(db, `${APP_PATH}/results`));
  resultsMap = snap.exists() ? snap.val() : {};
}

async function loadEntries() {
  const snap = await get(ref(db, `${APP_PATH}/entries`));
  const v = snap.exists() ? snap.val() : {};
  allEntries = Object.entries(v).map(([id,e]) => ({...e, _id:id}));
  document.getElementById("kTotal").textContent = allEntries.length;
  document.getElementById("kToday").textContent = allEntries.filter(e => e.dayKey === todayKeyCairo()).length;
  renderChart(allEntries);
}

function setKpiCorrect() {
  const el = document.getElementById("kCorrect");
  if(!selectedMatch) { el.textContent = "0"; return; }
  const winner = resultsMap?.[selectedMatch.id] || null;
  if(!winner) { el.textContent = "0"; return; }
  const correct = allEntries.filter(e => e.matchId === selectedMatch.id && e.pickedTeam === winner);
  el.textContent = correct.length;
}

function renderTable() {
  const mode = document.getElementById("filterMode").value;
  let rows = allEntries.slice();
  if(mode === "today") rows = rows.filter(e => e.dayKey === todayKeyCairo());
  if(mode === "selectedMatch" && selectedMatch) rows = rows.filter(e => e.matchId === selectedMatch.id);
  if(mode === "correctOnly" && selectedMatch) {
    const winner = resultsMap?.[selectedMatch.id];
    rows = winner ? rows.filter(e => e.matchId === selectedMatch.id && e.pickedTeam === winner) : [];
  }
  rows.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML = "";
  rows.slice(0, 400).forEach(e => {
    const tr = document.createElement("tr");
    const t = new Date(e.createdAt || Date.parse(e.createdAtIso));
    const time = new Intl.DateTimeFormat('en-US', {timeZone:'Africa/Cairo', hour:'2-digit', minute:'2-digit', day:'2-digit', month:'short'}).format(t);
    tr.innerHTML = `
      <td>${(e.fullName||"—")}</td>
      <td>${(e.phone||"—")}</td>
      <td>${(e.email||"—")}</td>
      <td>${(e.matchLabel||e.matchId||"—")}</td>
      <td>${(e.pickedTeam||"—")}</td>
      <td>${time}</td>
    `;
    tb.appendChild(tr);
  });
}

async function loadDay(dayKey) {
  currentDay = dayKey;
  document.getElementById("dayChip").textContent = `Day: ${dayKey}`;
  const snap = await get(ref(db, `${APP_PATH}/cache/matchesByDate/${dayKey}/matches`));
  dayMatches = snap.exists() ? snap.val() : [];
  const sel = document.getElementById("matchSel");
  sel.innerHTML = "";
  if(!dayMatches.length) {
    const o = document.createElement("option");
    o.value=""; o.textContent="No matches for this day (import fixtures)";
    sel.appendChild(o);
    sel.disabled = true;
  } else {
    sel.disabled = false;
    const now = Date.now();
    dayMatches.forEach(m => {
      const o = document.createElement("option");
      o.value = m.id;
      o.textContent = m.label + (now >= m.cutoff ? " (Voting closed)" : "");
      sel.appendChild(o);
    });
  }
  // select first
  if(dayMatches.length) {
    selectedMatch = dayMatches[0];
    sel.value = selectedMatch.id;
    onSelectMatch(selectedMatch.id);
  } else {
    selectedMatch = null;
    document.getElementById("matchChip").textContent = "Match: —";
    document.getElementById("statusChip").textContent = "Status: —";
  }
  setKpiCorrect();
  renderTable();
}

function onSelectMatch(matchId) {
  selectedMatch = dayMatches.find(m => String(m.id) === String(matchId)) || null;
  document.getElementById("matchChip").textContent = selectedMatch ? `Match: ${selectedMatch.home} vs ${selectedMatch.away}` : "Match: —";
  const now = Date.now();
  const st = selectedMatch ? (now >= selectedMatch.cutoff ? "Closed" : "Open") : "—";
  const chip = document.getElementById("statusChip");
  chip.textContent = `Status: ${st}`;
  chip.className = "chip " + (st==="Open"?"open":(st==="Closed"?"closed":""));
  // winner select
  const ws = document.getElementById("winnerTeamSel");
  ws.innerHTML = "";
  if(!selectedMatch) {
    ws.disabled = true;
    document.getElementById("setResultBtn").disabled = true;
    return;
  }
  [selectedMatch.home, selectedMatch.away].forEach(t => {
    const o = document.createElement("option");
    o.value=t; o.textContent=t;
    ws.appendChild(o);
  });
  ws.disabled = false;
  document.getElementById("setResultBtn").disabled = false;
  // if already set, preselect
  const already = resultsMap?.[selectedMatch.id];
  if(already) ws.value = already;
  setKpiCorrect();
}

async function setResult() {
  if(!selectedMatch) return;
  const winner = document.getElementById("winnerTeamSel").value;
  await set(ref(db, `${APP_PATH}/results/${selectedMatch.id}`), winner);
  resultsMap[selectedMatch.id] = winner;
  log(`Set result for match ${selectedMatch.id} = ${winner}`);
  setKpiCorrect();
  renderTable();
}

function openWinner() {
  // winner.html reads from same RTDB; pass day+match in hash (not URL params rule is for receipt, but this is internal admin)
  const hash = selectedMatch ? `#day=${encodeURIComponent(currentDay)}&match=${encodeURIComponent(selectedMatch.id)}` : "";
  window.open("winner_v3.html"+hash, "_blank");
}

async function exportCSV() {
  const mode = document.getElementById("filterMode").value;
  let rows = allEntries.slice();
  if(mode === "today") rows = rows.filter(e => e.dayKey === todayKeyCairo());
  if(mode === "selectedMatch" && selectedMatch) rows = rows.filter(e => e.matchId === selectedMatch.id);
  if(mode === "correctOnly" && selectedMatch) {
    const winner = resultsMap?.[selectedMatch.id];
    rows = winner ? rows.filter(e => e.matchId === selectedMatch.id && e.pickedTeam === winner) : [];
  }
  const header = ["fullName","phone","email","matchId","matchLabel","pickedTeam","dayKey","kickoffIso","createdAtIso"];
  const csv = [header.join(",")].concat(rows.map(r => header.map(k => JSON.stringify(r[k] ?? "")).join(","))).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `afcon_entries_${mode}_${todayKeyCairo()}.csv`;
  a.click();
}

async function exportPDF() {
  const area = document.getElementById("exportArea");
  const canvas = await html2canvas(area, {scale:2, backgroundColor:null});
  const img = canvas.toDataURL("image/png");
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({orientation:"p", unit:"pt", format:"a4"});
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  // fit image
  const ratio = Math.min(pageW/canvas.width, pageH/canvas.height);
  const w = canvas.width * ratio;
  const h = canvas.height * ratio;
  pdf.addImage(img, "PNG", (pageW-w)/2, 18, w, h);
  pdf.save(`afcon_dashboard_${todayKeyCairo()}.pdf`);
}

function showTemplate() {
  alert(
`JSON template (array):
[
  {
    "id":"AFCON_2025_M01",
    "home":"Egypt",
    "away":"Nigeria",
    "kickoffIso":"2025-01-10T19:00:00+02:00"
  }
]

CSV headers:
id,home,away,kickoffIso
AFCON_2025_M01,Egypt,Nigeria,2025-01-10T19:00:00+02:00
`
  );
}

document.getElementById("saveFlyerBtn").addEventListener("click", saveFlyer);
document.getElementById("importBtn").addEventListener("click", importFixtures);
document.getElementById("templateBtn").addEventListener("click", showTemplate);
document.getElementById("rebuildTodayBtn").addEventListener("click", rebuildToday);
document.getElementById("clearCacheBtn").addEventListener("click", clearMatchCache);
document.getElementById("loadDayBtn").addEventListener("click", () => {
  const v = document.getElementById("dayPick").value;
  if(!v) return;
  loadDay(v);
});
document.getElementById("matchSel").addEventListener("change", (e)=> onSelectMatch(e.target.value));
document.getElementById("setResultBtn").addEventListener("click", setResult);
document.getElementById("openWinnerBtn").addEventListener("click", openWinner);
document.getElementById("refreshBtn").addEventListener("click", async ()=>{ await loadResults(); await loadEntries(); setKpiCorrect(); renderTable(); });
document.getElementById("csvBtn").addEventListener("click", exportCSV);
document.getElementById("pdfBtn").addEventListener("click", exportPDF);

// api calls KPI (manual bump)
(async function initApiKpi() {
  const key = `apiCalls_${todayKeyCairo()}`;
  const cur = parseInt(localStorage.getItem(key) || "0", 10);
  document.getElementById("kApi").textContent = String(cur);
})();

(async function init() {
  // init date picker to today in Cairo
  document.getElementById("dayPick").value = todayKeyCairo();
  // load flyer url
  const f = await get(ref(db, `${APP_PATH}/config/flyerUrl`));
  if(f.exists()) document.getElementById("flyerUrl").value = f.val() || "";
  await loadResults();
  await loadEntries();
  await loadDay(todayKeyCairo());
})();

</script>

</body>
</html>
