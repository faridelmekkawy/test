<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>AFCON Nights — Pick a Winner</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f1a; --ink:#f8fafc; --muted:rgba(248,250,252,.75);
  --border:rgba(255,255,255,.12); --accent:#22c55e; --danger:#ef4444;
  --radius:18px; --shadow:0 18px 50px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{min-height:100vh;background:var(--bg);color:var(--ink);}
.wrap{height:100%;overflow:auto;scroll-snap-type:y mandatory;}
.screen{min-height:100vh;scroll-snap-align:start;position:relative;}
.hero{display:flex;align-items:flex-end;justify-content:center; position:relative;min-height:100vh;overflow:hidden;}
.heroImg{position:absolute;inset:0;background:url("https://firebasestorage.googleapis.com/v0/b/events-339ce.firebasestorage.app/o/WhatsApp%20Image%202025-12-16%20at%205.48.09%20PM.jpeg?alt=media&token=126fb0c7-2576-4265-a080-bb860e131820") center center / contain no-repeat;}

.heroShade{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,.25),rgba(0,0,0,.75));}

    .heroImg{pointer-events:none}
    .heroShade{pointer-events:none}
    .heroFooter{position:absolute;left:0;right:0;bottom:18px;z-index:10;display:flex;justify-content:center;pointer-events:auto}
    .ctaRow{width:100%;display:flex;justify-content:center}
    #btnVote{min-width:min(520px,92vw);padding:18px 22px;border-radius:22px;font-size:22px;font-weight:900;letter-spacing:.2px;box-shadow:0 18px 40px rgba(0,0,0,.35);background:linear-gradient(135deg,#22c55e,#16a34a);border:0;color:#06130b}
.heroFooter{position:absolute;left:0;right:0;bottom:18px;z-index:10;display:flex;justify-content:center;pointer-events:auto}
.ctaRow{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
.pill{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.10);backdrop-filter:blur(8px);}
.btn{appearance:none;border:0;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:800;letter-spacing:.2px;}
.btn.primary{background:linear-gradient(135deg,var(--accent),#16a34a);color:#071014;}
.btn.ghost{background:rgba(255,255,255,.12);color:var(--ink);border:1px solid var(--border);}
.note{font-size:13px;color:var(--muted);line-height:1.35;}
.formScreen{display:flex;align-items:center;justify-content:center;padding:22px 14px;}
.bgBlur{position:absolute;inset:0;background:url("https://firebasestorage.googleapis.com/v0/b/events-339ce.firebasestorage.app/o/WhatsApp%20Image%202025-12-16%20at%205.48.09%20PM.jpeg?alt=media&token=126fb0c7-2576-4265-a080-bb860e131820") center center / contain no-repeat;filter:blur(14px);transform:scale(1.06);}

.bgOverlay{position:absolute;inset:0;background:rgba(0,0,0,.62);}
.card{position:relative;width:min(720px,92vw);background:rgba(255,255,255,.10);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(14px);overflow:hidden;}
.cardHead{padding:18px 18px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;}
.cardHead h2{margin:0;font-size:18px;}
.cardHead .small{font-size:12px;color:var(--muted);}
form{padding:16px 18px 18px;display:grid;gap:12px;}
.row{display:grid;gap:8px;}
label{font-size:12px;color:var(--muted);font-weight:700;letter-spacing:.2px;}
input,select{width:100%;padding:12px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.16);outline:none;background:rgba(0,0,0,.25);color:var(--ink);font-weight:600;}
input::placeholder{color:rgba(248,250,252,.55)}
.two{display:grid;gap:12px;grid-template-columns:1fr 1fr;}
@media(max-width:640px){.two{grid-template-columns:1fr}}
.help{font-size:12px;color:var(--muted);margin-top:-6px;}
.error{font-size:12px;color:#fecaca;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.22);padding:10px 12px;border-radius:14px;display:none;}
.ok{font-size:12px;color:#bbf7d0;background:rgba(34,197,94,.10);border:1px solid rgba(34,197,94,.22);padding:10px 12px;border-radius:14px;display:none;}
.footer{padding:12px 16px 18px;text-align:center;color:rgba(248,250,252,.55);font-size:12px;}
.kickTag{font-weight:800;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.08);}

/* --- SevenApes tweaks (UI only) --- */
.heroFooter .ctaRow{justify-content:center;}
#btnVote{font-size:22px;padding:16px 28px;border-radius:18px;min-width:min(360px,92vw);}
@media(max-width:420px){#btnVote{min-width:92vw;font-size:20px;padding:16px 22px;}}
/* Show full flyer without cropping */
.heroImg{background-color:#000;}

.hero::before{
  content:"";
  position:absolute;inset:0;
  background:url("https://firebasestorage.googleapis.com/v0/b/events-339ce.firebasestorage.app/o/WhatsApp%20Image%202025-12-16%20at%205.48.09%20PM.jpeg?alt=media&token=126fb0c7-2576-4265-a080-bb860e131820") center center / cover no-repeat;
  filter:blur(22px);
  transform:scale(1.08);
  opacity:.55;
}
.hero::after{
  content:"";
  position:absolute;inset:0;
  background:linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.72));
}
.heroInner{position:relative;z-index:3;}
.heroImg{position:absolute;inset:0;z-index:1;background:url("https://firebasestorage.googleapis.com/v0/b/events-339ce.firebasestorage.app/o/WhatsApp%20Image%202025-12-16%20at%205.48.09%20PM.jpeg?alt=media&token=126fb0c7-2576-4265-a080-bb860e131820") center center / contain no-repeat;}

</style>
</head>
<body>
<div class="wrap" id="wrap">
  <section class="screen hero" id="hero">
    <div class="heroImg" id="heroImg"></div>
    <div class="heroShade"></div>
    <div class="heroFooter">
      <div class="ctaRow">
<button class="btn primary" id="btnVote">Vote now</button>
      </div>
      <div style="height:12px"></div>
</div>
  </section>

  <section class="screen formScreen" id="formScreen">
    <div class="bgBlur" id="bgBlur"></div>
    <div class="bgOverlay"></div>

    <div class="card">
      <div class="cardHead">
        <div>
          <h2>Pick the winning team</h2>
          <div class="small" id="todayLabel">Today (Cairo)</div>
        </div>
        <div class="kickTag" id="apiState">Loading…</div>
      </div>

      <form id="voteForm" autocomplete="on">
        <div class="error" id="err"></div>
        <div class="ok" id="ok"></div>

        <div class="two">
          <div class="row">
            <label>Full name</label>
            <input id="fullName" placeholder="Your full name" required/>
          </div>
          <div class="row">
            <label>Phone</label>
            <input id="phone" placeholder="01xxxxxxxxx" inputmode="tel" required/>
          </div>
        </div>

        <div class="two">
          <div class="row">
            <label>Email</label>
            <input id="email" placeholder="optional@email.com" inputmode="email"/>
          </div>
          <div class="row">
            <label>Date (Cairo)</label>
            <input id="dateSel" type="date" required/>
            <div class="help" id="dateHelp">For testing: pick a date to load matches from cache.</div>
          </div>

          <div class="row">
            <label>Match you’re watching</label>
            <select id="matchSel" required>
              <option value="">Loading today’s matches…</option>
            </select>
            <div class="help" id="matchHelp"></div>
          </div>
        </div>

        <div class="row">
          <label>Team you think will win</label>
          <select id="teamSel" required disabled>
            <option value="">Select a match first</option>
          </select>
          <div class="help">This dropdown auto-updates to the two teams in the selected match.</div>
        </div>

        <button class="btn primary" type="submit">Submit vote</button>
      </form>

      <div class="footer">Powered by SevenApes</div>
    </div>
  </section>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
// ✅ Firebase config (paste your usual "events one" config here)
const firebaseConfig = {
      apiKey: "AIzaSyA80bAAGPuyscnTVS-zwrxE9Jp3tPiS1gM",
      authDomain: "events-339ce.firebaseapp.com",
      databaseURL: "https://events-339ce-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "events-339ce",
      storageBucket: "events-339ce.appspot.com",
      messagingSenderId: "175601544315",
      appId: "1:175601544315:web:00c94b4affa972b3a286de"
};

const TZ = "Africa/Cairo";
const PATHS = {
  configFlyerUrl: "afconApp/config/flyerUrl",
  matchesByDate: (dayKey)=>"afconApp/cache/matchesByDate/"+dayKey+"/matches",
  entries: "afconApp/entries"
};
const VOTE_WINDOW_MS = (2*60+3)*60*1000;

function cairoDayKey(d=new Date()) {
  const parts = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" }).formatToParts(d);
  const get = (t)=>parts.find(p=>p.type===t)?.value;
  return get("year")+"-"+get("month")+"-"+get("day");
}
function fmtCairoTime(isoOrMs) {
  const d = typeof isoOrMs === "number" ? new Date(isoOrMs) : new Date(isoOrMs);
  return new Intl.DateTimeFormat("en-GB", { timeZone: TZ, hour:"2-digit", minute:"2-digit" }).format(d);
}
function nowMs() { return Date.now(); }

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const btnVote = document.getElementById("btnVote");
const matchSel = document.getElementById("matchSel");
const teamSel  = document.getElementById("teamSel");
const dateSel  = document.getElementById("dateSel");
const dateHelp = document.getElementById("dateHelp");
const err = document.getElementById("err");
const ok = document.getElementById("ok");
const apiState = document.getElementById("apiState");
const matchHelp = document.getElementById("matchHelp");
const heroImg = document.getElementById("heroImg");
const bgBlur = document.getElementById("bgBlur");
const todayLabel = document.getElementById("todayLabel");

let matches = [];
let selectedMatch = null;
let dayKey = cairoDayKey();

// Smooth scroll with controllable duration (slightly slower than default)
function smoothScrollTo(targetY, durationMs){
  const startY = window.pageYOffset || document.documentElement.scrollTop || 0;
  const diff = targetY - startY;
  const startT = performance.now();
  const easeInOut = (t)=> t<0.5 ? 2*t*t : 1- Math.pow(-2*t+2,2)/2;
  function step(now){
    const p = Math.min(1, (now - startT) / durationMs);
    const y = startY + diff * easeInOut(p);
    window.scrollTo(0, y);
    if (p < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
// Swipe down on hero to open form (mobile)
(function(){
  const hero = document.getElementById("hero");
  if(!hero) return;
  let y0=null;
  hero.addEventListener("touchstart", (e)=>{ y0 = e.touches && e.touches[0] ? e.touches[0].clientY : null; }, {passive:true});
  hero.addEventListener("touchend", (e)=>{
    if(y0==null) return;
    const y1 = e.changedTouches && e.changedTouches[0] ? e.changedTouches[0].clientY : null;
    if(y1!=null && (y1 - y0) > 60){
      document.getElementById("formScreen").scrollIntoView({behavior:"smooth", block:"start"});
      }
    y0=null;
  }, {passive:true});
})();


btnVote.addEventListener("click", () => {
  document.getElementById("formScreen").scrollIntoView({behavior:"smooth", block:"start"});
});

function showErr(text) { err.style.display="block"; err.textContent=text; ok.style.display="none"; }
function showOk(text) { ok.style.display="block"; ok.textContent=text; err.style.display="none"; }
function clearMsgs() { err.style.display="none"; ok.style.display="none"; }

async function loadSettingsAndBranding() {
  const snap = await db.ref(PATHS.configFlyerUrl).get();
  const flyerUrl = snap.exists() ? String(snap.val()||"").trim() : "";
  const fallback = "https://firebasestorage.googleapis.com/v0/b/events-339ce.firebasestorage.app/o/WhatsApp%20Image%202025-12-16%20at%205.48.09%20PM.jpeg?alt=media&token=126fb0c7-2576-4265-a080-bb860e131820";
  const url = flyerUrl || fallback;
  heroImg.style.backgroundImage = `url('${url}')`;
  bgBlur.style.backgroundImage  = `url('${url}')`;
  todayLabel.textContent = `Date (${TZ}) — ${dayKey}`;
}

function computeState(m) {
  const kickoffIso = m.kickoffIso || m.kickoffISO || m.kickoff || null;
  const kickoffMs = kickoffIso ? new Date(kickoffIso).getTime() : NaN;
  const cutoffMs = (typeof m.cutoff === 'number') ? m.cutoff : (kickoffIso ? (kickoffMs + VOTE_WINDOW_MS) : NaN);
  return { kickoffMs, cutoffMs, isOpen: Number.isFinite(cutoffMs) ? (nowMs() < cutoffMs) : false };
}

function renderMatches() {
  matchSel.innerHTML = "";
  if (!matches.length) {
    const o = document.createElement("option");
    o.value=""; o.textContent="No matches cached for this date yet.";
    matchSel.appendChild(o);
    matchSel.disabled = true;
    teamSel.disabled = true;
    apiState.textContent = "No data";
    matchHelp.textContent = "";
    return;
  }
  matchSel.disabled = false;
  apiState.textContent = "Ready";
  matchHelp.textContent = "Closed matches are visible but disabled.";
  const ph = document.createElement("option");
  ph.value=""; ph.textContent="Select today’s match…";
  matchSel.appendChild(ph);

  matches.forEach(m => {
    const st = computeState(m);
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = m.home+" vs "+m.away+" — "+fmtCairoTime(m.kickoffIso) + (st.isOpen ? "" : " (Voting closed)");
    opt.disabled = !st.isOpen;
    matchSel.appendChild(opt);
  });
}

function renderTeamsForMatch(m) {
  teamSel.innerHTML = "";
  const st = computeState(m);
  if (!st.isOpen) {
    teamSel.disabled = true;
    const o = document.createElement("option");
    o.value=""; o.textContent="Voting closed for this match";
    teamSel.appendChild(o);
    return;
  }
  teamSel.disabled = false;
  const p = document.createElement("option");
  p.value=""; p.textContent="Pick the winner…";
  teamSel.appendChild(p);
  [m.home, m.away].forEach(t => {
    const o = document.createElement("option");
    o.value=t; o.textContent=t;
    teamSel.appendChild(o);
  });
}

matchSel.addEventListener("change", () => {
  clearMsgs();
  const id = matchSel.value;
  selectedMatch = matches.find(x => String(x.id) === String(id)) || null;
  if (!selectedMatch) {
    teamSel.disabled = true;
    teamSel.innerHTML = "<option value=''>Select a match first</option>";
    return;
  }
  renderTeamsForMatch(selectedMatch);
});

async function loadTodayMatchesCache(dayOverride=null) {
  dayKey = (dayOverride && String(dayOverride).trim()) ? String(dayOverride).trim() : cairoDayKey();
  // Read cached matches for the selected day
  const snap = await db.ref(PATHS.matchesByDate(dayKey)).get();
  if (!snap.exists()) {
    matches = [];
    renderMatches();
    return;
  }
  const data = snap.val();
  matches = Array.isArray(data) ? data : [];
  matches.sort((a,b)=> new Date(a.kickoffIso) - new Date(b.kickoffIso));
  renderMatches();
}

setInterval(() => {
  if (!matches.length) return;
  const cur = matchSel.value;
  renderMatches();
  if (cur) {
    matchSel.value = cur;
    const m = matches.find(x=>String(x.id)===String(cur));
    if (m) renderTeamsForMatch(m);
  }
}, 60000);

document.getElementById("voteForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  clearMsgs();

  const fullName = document.getElementById("fullName").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const email = document.getElementById("email").value.trim();
  const matchId = matchSel.value;
  const pickedTeam = teamSel.value;

  if (!fullName || !phone || !matchId || !pickedTeam) return showErr("Please fill all required fields.");

  const m = matches.find(x => String(x.id) === String(matchId));
  if (!m) return showErr("This match is not available right now.");

  const st = computeState(m);
  if (!st.isOpen) return showErr("Voting is closed for this match.");
  if (![m.home, m.away].includes(pickedTeam)) return showErr("Invalid team selection.");

  const payload = {
    fullName, phone,
    email: email || null,
    matchId: m.id,
    matchLabel: (m.label || (m.home+" vs "+m.away+" — "+fmtCairoTime(m.kickoffIso))),
    kickoffIso: m.kickoffIso,
    pickedTeam,
    createdAt: firebase.database.ServerValue.TIMESTAMP,
    tz: TZ
  };

  try {
    await db.ref(PATHS.entries).push(payload);
    showOk("✅ Vote submitted! Good luck.");
    document.getElementById("voteForm").reset();
    teamSel.disabled = true;
    teamSel.innerHTML = "<option value=''>Select a match first</option>";
    matchSel.value = "";
  } catch (ex) {
    console.error(ex);
    showErr("Could not submit. Please try again.");
  }
});

(async function init() {
  // Date picker (testing)
  if (dateSel) {
    const dk = cairoDayKey();
    dateSel.value = dk;
    if (dateHelp) dateHelp.textContent = `For testing: showing matches for ${dk} (Cairo)`;
    dateSel.addEventListener("change", async () => {
      const val = dateSel.value || cairoDayKey();
      if (dateHelp) dateHelp.textContent = `For testing: showing matches for ${val} (Cairo)`;
      await loadTodayMatchesCache(val);
    });
  }

  await loadSettingsAndBranding();
  await loadTodayMatchesCache((dateSel && dateSel.value) ? dateSel.value : null);
})();
</script>
</body>
</html>
